<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacientes ‚Äî Zimy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .badge-status {
            font-size: 0.72rem;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .badge-online {
            background: rgba(52, 211, 153, 0.15);
            color: #34D399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .badge-offline {
            background: rgba(107, 114, 128, 0.15);
            color: #9CA3AF;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .search-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            color: #fff;
            width: 100%;
            max-width: 400px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--neon-blue);
            background: rgba(255, 255, 255, 0.08);
        }
    </style>
</head>

<body>
    <!-- Background Decoration -->
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div style="margin-bottom: 3rem;">
            <a href="dashboard.html" class="navbar-brand fs-3">
                <span style="color: var(--neon-blue);">Zi</span>my
            </a>
        </div>
        <nav class="d-flex flex-column gap-1">
            <a href="dashboard.html" class="sidebar-link">
                <i class="fas fa-home"></i><span>Dashboard</span>
            </a>
            <a href="chat.html" class="sidebar-link">
                <i class="fas fa-comment-medical"></i><span>Chat</span>
            </a>
            <a href="patients.html" class="sidebar-link active">
                <i class="fas fa-users"></i><span>Pacientes</span>
            </a>
            <a href="relatorios.html" class="sidebar-link">
                <i class="fas fa-chart-pie"></i><span>Relat√≥rios</span>
            </a>
            <a href="profile.html" class="sidebar-link">
                <i class="fas fa-user-circle"></i><span>Meu Perfil</span>
            </a>
        </nav>
        <div style="margin-top: auto; padding-top: 2rem;">
            <a href="#" id="logoutBtn" class="sidebar-link" style="color: var(--soft-red);">
                <i class="fas fa-sign-out-alt"></i><span>Sair</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="h3 mb-1">Meus Pacientes</h1>
                <p class="text-dim small mb-0">Gerencie todos os seus pacientes em um s√≥ lugar.</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-lg-block">
                    <div class="fw-semibold" id="userNameTop" style="font-size:0.9rem;"></div>
                    <div class="small" style="color: var(--text-dim);" id="userEmailTop"></div>
                </div>
                <a href="profile.html" id="userPhoto"
                    style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#7C3AED,#2563EB);display:flex;align-items:center;justify-content:center;font-size:1.3rem;overflow:hidden;cursor:pointer;text-decoration:none;">
                    üßë‚Äç‚öïÔ∏è
                </a>
            </div>
        </div>

        <!-- Filters and List -->
        <div class="glass-card" style="padding: 2rem;">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
                <input type="text" class="search-input" id="searchPatients" placeholder="üîç  Buscar por nome...">
                <div class="d-flex gap-2">
                    <button class="btn btn-zimy-outline btn-sm px-3"><i class="fas fa-filter me-2"></i>Filtrar</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead>
                        <tr style="border-bottom:1px solid var(--glass-border);">
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;">
                                Paciente</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;">
                                Status</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;">
                                √öltima Atividade</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;">
                                Progresso</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;">
                            </th>
                        </tr>
                    </thead>
                    <tbody id="patientsFullTableBody">
                        <tr>
                            <td colspan="5" class="text-center py-5 opacity-50">
                                <div class="spinner-border spinner-border-sm text-info me-2"></div>
                                Carregando pacientes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="firebase-config.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = window.Zimy.db.getSession();
            if (user) {
                document.getElementById('userNameTop').innerText = user.name || '';
                document.getElementById('userEmailTop').innerText = user.email || '';
                if (user.photoURL) {
                    document.getElementById('userPhoto').innerHTML = `<img src="${user.photoURL}" style="width:100%; height:100%; object-fit:cover;">`;
                }
            }
            fetchAllPatients();

            // Search filtering
            document.getElementById('searchPatients').addEventListener('input', function () {
                const q = this.value.toLowerCase();
                document.querySelectorAll('#patientsFullTableBody tr').forEach(row => {
                    if (row.dataset.name) {
                        row.style.display = row.dataset.name.includes(q) ? '' : 'none';
                    }
                });
            });
        });

        async function fetchAllPatients() {
            const user = window.Zimy.db.getSession();
            if (!user) return;

            try {
                const { query } = window.zimyFirebase;
                const chats = await query("chats", [
                    { field: "participantIds", op: "ARRAY_CONTAINS", value: user.uid }
                ]);

                const container = document.getElementById('patientsFullTableBody');

                if (chats.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-5 opacity-50">
                                <i class="fas fa-user-slash fs-2 mb-3 d-block"></i>
                                <span>Ainda n√£o h√° pacientes com conversas ativas.</span>
                            </td>
                        </tr>
                    `;
                    return;
                }

                container.innerHTML = chats.map(chat => {
                    const data = chat.data();
                    const patName = data.patientName || 'Paciente';
                    const lastDate = data.lastMessageAt ? new Date(data.lastMessageAt).toLocaleDateString() : '---';

                    return `
                        <tr data-name="${patName.toLowerCase()}">
                            <td style="padding:1.2rem 0;">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="width:40px;height:40px;border-radius:12px;background:rgba(124,58,237,0.15);display:flex;align-items:center;justify-content:center;font-weight:bold;color:#A78BFA;">
                                        ${patName.charAt(0)}
                                    </div>
                                    <div>
                                        <div class="fw-semibold">${patName}</div>
                                        <div class="small text-dim">ID: ${chat.id.replace(user.uid, '').replace('_', '')}</div>
                                    </div>
                                </div>
                            </td>
                            <td><span class="badge-status badge-online">online</span></td>
                            <td style="color:var(--text-dim);font-size:0.9rem;">${lastDate}</td>
                            <td>
                                <div class="progress" style="height: 6px; width: 100px; background: rgba(255,255,255,0.05); border-radius:10px;">
                                    <div class="progress-bar" style="width: 65%; background: var(--neon-blue); border-radius:10px;"></div>
                                </div>
                            </td>
                            <td class="text-end">
                                <a href="chat.html?chatId=${chat.id}" class="btn btn-zimy-primary btn-sm px-3">Abrir Chat</a>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error("Error fetching all patients:", error);
                document.getElementById('patientsFullTableBody').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">Erro ao carregar lista.</td></tr>`;
            }
        }
    </script>
</body>

</html>