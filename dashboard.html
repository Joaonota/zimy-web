<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel ‚Äî Zimy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .stat-icon.purple {
            background: rgba(124, 58, 237, 0.2);
            color: #A78BFA;
        }

        .stat-icon.blue {
            background: rgba(37, 99, 235, 0.2);
            color: #60A5FA;
        }

        .stat-icon.green {
            background: rgba(52, 211, 153, 0.15);
            color: #34D399;
        }

        .stat-card {
            border: 1px solid var(--glass-border);
        }

        .stat-card:hover {
            transform: translateY(-6px);
        }

        .alert-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .chart-bar {
            border-radius: 6px 6px 0 0;
            transition: opacity 0.3s;
        }

        .chart-bar:hover {
            opacity: 0.8;
        }

        .table-dark {
            --bs-table-bg: transparent;
        }

        .table-hover>tbody>tr:hover>* {
            background-color: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .badge-status {
            font-size: 0.72rem;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
        }

        .badge-online {
            background: rgba(52, 211, 153, 0.15);
            color: #34D399;
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .badge-offline {
            background: rgba(107, 114, 128, 0.15);
            color: #9CA3AF;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }
    </style>
</head>

<body>

    <!-- Background Decoration -->
    <div class="bg-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div style="margin-bottom: 3rem;">
            <a href="dashboard.html" class="navbar-brand fs-3">
                <span style="color: var(--neon-blue);">Zi</span>my
            </a>
        </div>
        <nav class="d-flex flex-column gap-1">
            <a href="dashboard.html" class="sidebar-link active">
                <i class="fas fa-home"></i><span id="navDashboard">Dashboard</span>
            </a>
            <a href="chat.html" class="sidebar-link">
                <i class="fas fa-comment-medical"></i><span id="navChat">Chat</span>
            </a>
            <a href="patients.html" class="sidebar-link">
                <i class="fas fa-users"></i><span id="navPatients">Pacientes</span>
            </a>
            <a href="relatorios.html" class="sidebar-link">
                <i class="fas fa-chart-pie"></i><span id="navReports">Relat√≥rios</span>
            </a>
            <a href="profile.html" class="sidebar-link">
                <i class="fas fa-user-circle"></i><span id="navProfile">Meu Perfil</span>
            </a>
        </nav>
        <div style="margin-top: auto; padding-top: 2rem;">
            <a href="#" id="logoutBtn" class="sidebar-link" style="color: var(--soft-red);">
                <i class="fas fa-sign-out-alt"></i><span id="navLogout">Sair</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <p class="mb-1"
                    style="font-size:0.85rem; letter-spacing: 0.05em; text-transform: uppercase; color: var(--neon-blue); font-family:'Poppins',sans-serif;"
                    id="lblPanelType">
                    Painel do Terapeuta</p>
                <h1 class="h3 mb-0"><span id="txtHello">Ol√°</span>, <span id="userName">Terapeuta</span> üëã</h1>
            </div>
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-zimy-outline btn-sm me-2" id="langToggle">EN / PT</button>
                <div class="text-end d-none d-lg-block">
                    <div class="fw-semibold" id="userNameTop" style="font-size:0.9rem;"></div>
                    <div class="small" style="color: var(--text-dim);" id="userEmailTop"></div>
                </div>
                <a href="profile.html" id="userPhoto"
                    style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#7C3AED,#2563EB);display:flex;align-items:center;justify-content:center;font-size:1.3rem;overflow:hidden;cursor:pointer;text-decoration:none;">
                    üßë‚Äç‚öïÔ∏è
                </a>
            </div>
        </div>

        <!-- Stat Cards -->
        <div class="row g-4 mb-5">
            <div class="col-sm-6 col-xl-4">
                <div class="glass-card stat-card">
                    <div class="d-flex gap-4 align-items-center">
                        <div class="stat-icon purple"><i class="fas fa-user-friends"></i></div>
                        <div>
                            <div class="h2 mb-0 fw-bold" id="statActivePatients">0</div>
                            <div style="font-size:0.85rem; color:var(--text-dim);" id="lblActivePatients">Pacientes
                                Ativos</div>
                        </div>
                        <div class="ms-auto text-success small fw-semibold" id="statActiveDiff">---</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-4">
                <div class="glass-card stat-card">
                    <div class="d-flex gap-4 align-items-center">
                        <div class="stat-icon blue"><i class="fas fa-comments"></i></div>
                        <div>
                            <div class="h2 mb-0 fw-bold" id="statConversations">0</div>
                            <div style="font-size:0.85rem; color:var(--text-dim);" id="lblConversations">Conversas / M√™s
                            </div>
                        </div>
                        <div class="ms-auto" style="font-size:0.8rem; color:#60A5FA;" id="statNewMsgs">0 novas</div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-4">
                <div class="glass-card stat-card">
                    <div class="d-flex gap-4 align-items-center">
                        <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                        <div>
                            <div class="h2 mb-0 fw-bold" id="statEngagement">0%</div>
                            <div style="font-size:0.85rem; color:var(--text-dim);" id="lblEngagement">Engajamento</div>
                        </div>
                        <div class="ms-auto" style="font-size:0.8rem; color:var(--text-dim);" id="lblGoal">Meta: ---
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart + Alerts Row -->
        <div class="row g-4 mb-5">
            <!-- Chart -->
            <div class="col-lg-8">
                <div class="glass-card h-100" style="padding: 2rem;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0 fw-bold" id="lblChartTitle">Humor M√©dio do Grupo</h5>
                        <span style="font-size:0.8rem; color:var(--text-dim); font-family:'Poppins',sans-serif;"
                            id="lblChartPeriod">√öltimos 7 dias</span>
                    </div>
                    <div id="humorChart"
                        style="position:relative; height: 200px; display:flex; align-items:flex-end; gap:10px; padding:0 8px;">
                        <div class="text-center w-100 opacity-50 small" id="lblChartEmpty">Aguardando dados cl√≠nicos...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div class="col-lg-4">
                <div class="glass-card h-100" style="padding: 2rem;">
                    <h5 class="mb-4 fw-bold" id="lblAlerts">Alertas</h5>
                    <div class="d-flex flex-column gap-3" id="alertsContainer">
                        <div class="text-center py-4 opacity-50 small" id="lblNoAlerts">Sem alertas no momento.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Requests -->
        <div id="requestsSection" class="glass-card mb-5 d-none"
            style="padding: 2rem; border: 1px solid var(--neon-blue);">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0 fw-bold"><i class="fas fa-user-plus me-2 text-info"></i> <span
                        id="lblSessionRequests">Novos Pedidos de Sess√£o</span></h5>
                <span class="badge bg-info" id="requestCount">0</span>
            </div>
            <div id="requestsContainer" class="row g-3">
                <!-- Requests will be injected here -->
            </div>
        </div>

        <!-- Patients Table -->
        <div class="glass-card" style="padding: 2rem;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0 fw-bold" id="lblRecentPatients">Pacientes Recentes</h5>
                <a href="chat.html" class="btn btn-zimy-outline btn-sm px-3" id="btnViewAll">Ver todos</a>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead>
                        <tr style="border-bottom:1px solid var(--glass-border);">
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;"
                                id="thPatient">
                                Paciente</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;"
                                id="thStatus">
                                Status</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;"
                                id="thSpecialty">
                                Especialidade</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;"
                                id="thLastSession">
                                √öltima Sess√£o</th>
                            <th style="font-size:0.8rem;font-weight:500;color:var(--text-dim);padding-bottom:1rem;">
                            </th>
                        </tr>
                    </thead>
                    <tbody id="patientsTableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="firebase-config.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const user = window.Zimy.db.getSession();
            if (user) {
                document.getElementById('userName').innerText = user.name;

                // Show name and email in top right
                document.getElementById('userNameTop').innerText = user.name || '';
                document.getElementById('userEmailTop').innerText = user.email || '';

                if (user.photoURL) {
                    document.getElementById('userPhoto').innerHTML = `<img src="${user.photoURL}" style="width:100%; height:100%; object-fit:cover;">`;
                } else if (user.initials) {
                    document.getElementById('userPhoto').innerText = user.initials;
                    document.getElementById('userPhoto').style.fontSize = '1.1rem';
                    document.getElementById('userPhoto').style.color = '#fff';
                }
            }
            fetchRecentPatients();

            // Language management
            let currentLang = localStorage.getItem('zimy_lang') || 'pt';
            const translations = {
                pt: {
                    // Header
                    lblPanelType: 'Painel do Terapeuta',
                    txtHello: 'Ol√°',
                    // Sidebar
                    navDashboard: 'Dashboard',
                    navChat: 'Chat',
                    navPatients: 'Pacientes',
                    navReports: 'Relat√≥rios',
                    navProfile: 'Meu Perfil',
                    navLogout: 'Sair',
                    // Stat Cards
                    lblActivePatients: 'Pacientes Ativos',
                    lblConversations: 'Conversas / M√™s',
                    statNewMsgs: '0 novas',
                    lblEngagement: 'Engajamento',
                    lblGoal: 'Meta: ---',
                    // Chart
                    lblChartTitle: 'Humor M√©dio do Grupo',
                    lblChartPeriod: '√öltimos 7 dias',
                    lblChartEmpty: 'Aguardando dados cl√≠nicos...',
                    // Alerts
                    lblAlerts: 'Alertas',
                    lblNoAlerts: 'Sem alertas no momento.',
                    // Patients Table
                    lblRecentPatients: 'Pacientes Recentes',
                    btnViewAll: 'Ver todos',
                    thPatient: 'Paciente',
                    thStatus: 'Status',
                    thSpecialty: 'Especialidade',
                    thLastSession: '√öltima Sess√£o',
                    txtNoPatients: 'Nenhum paciente cadastrado ainda.',
                    // Requests
                    lblSessionRequests: 'Novos Pedidos de Sess√£o',
                    btnAccept: 'Aceitar',
                    btnReject: 'Recusar',
                    msgCreatingChat: 'Iniciando chat...',
                },
                en: {
                    // Header
                    lblPanelType: 'Therapist Dashboard',
                    txtHello: 'Hello',
                    // Sidebar
                    navDashboard: 'Dashboard',
                    navChat: 'Chat',
                    navPatients: 'Patients',
                    navReports: 'Reports',
                    navProfile: 'My Profile',
                    navLogout: 'Logout',
                    // Stat Cards
                    lblActivePatients: 'Active Patients',
                    lblConversations: 'Conversations / Month',
                    statNewMsgs: '0 new',
                    lblEngagement: 'Engagement',
                    lblGoal: 'Goal: ---',
                    // Chart
                    lblChartTitle: 'Average Group Mood',
                    lblChartPeriod: 'Last 7 days',
                    lblChartEmpty: 'Waiting for clinical data...',
                    // Alerts
                    lblAlerts: 'Alerts',
                    lblNoAlerts: 'No alerts at the moment.',
                    // Patients Table
                    lblRecentPatients: 'Recent Patients',
                    btnViewAll: 'View all',
                    thPatient: 'Patient',
                    thStatus: 'Status',
                    thSpecialty: 'Specialty',
                    thLastSession: 'Last Session',
                    txtNoPatients: 'No patients registered yet.',
                    // Requests
                    lblSessionRequests: 'New Session Requests',
                    btnAccept: 'Accept',
                    btnReject: 'Reject',
                    msgCreatingChat: 'Starting chat...',
                }
            };

            const applyLang = () => {
                const t = translations[currentLang];
                for (const [id, val] of Object.entries(t)) {
                    const el = document.getElementById(id);
                    if (el) el.innerText = val;
                }
                localStorage.setItem('zimy_lang', currentLang);
            };

            document.getElementById('langToggle').addEventListener('click', () => {
                currentLang = currentLang === 'pt' ? 'en' : 'pt';
                applyLang();
            });

            applyLang();

            // Stagger card entrance
            document.querySelectorAll('.glass-card').forEach((card, i) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, i * 80);
            });

            // Initial fetch
            fetchSessionRequests();
            fetchRecentPatients();
        });

        async function fetchSessionRequests() {
            const user = window.Zimy.db.getSession();
            console.log("Checking session requests for UID:", user ? user.uid : "NO USER");
            if (!user || !user.uid) return;

            try {
                const { query } = window.zimyFirebase;
                console.log("Running query on session_requests...");
                // Query pending requests for this therapist
                const requests = await query("session_requests", [
                    { field: "therapistId", op: "EQUAL", value: user.uid },
                    { field: "status", op: "EQUAL", value: "pending" }
                ]);
                console.log("Requests found:", requests.length, requests);

                const section = document.getElementById('requestsSection');
                const container = document.getElementById('requestsContainer');
                const countBadge = document.getElementById('requestCount');

                if (requests.length > 0) {
                    section.classList.remove('d-none');
                    countBadge.innerText = requests.length;

                    container.innerHTML = requests.map(req => {
                        const data = req.data();
                        return `
                            <div class="col-md-6 col-lg-4">
                                <div class="p-3 rounded-4" style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);">
                                    <div class="d-flex align-items-center gap-3 mb-3">
                                        <div style="width:40px;height:40px;border-radius:50%;background:rgba(34,211,238,0.2);display:flex;align-items:center;justify-content:center;font-weight:bold;">
                                            ${data.userInitials || 'P'}
                                        </div>
                                        <div>
                                            <div class="fw-bold" style="font-size:0.9rem;">${data.userName || 'Paciente'}</div>
                                            <div class="small opacity-50">Solicitou hoje</div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-zimy-primary btn-sm flex-grow-1" onclick="handleRequest('${req.id}', 'accepted', '${data.userId}', '${data.userName}')">
                                            <span id="btnAccept">Aceitar</span>
                                        </button>
                                        <button class="btn btn-zimy-outline btn-sm flex-grow-1" onclick="handleRequest('${req.id}', 'rejected')">
                                            <span id="btnReject">Recusar</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    section.classList.add('d-none');
                }
            } catch (error) {
                console.error("Error fetching requests:", error);
            }
        }

        async function handleRequest(requestId, status, userId, userName) {
            const { doc, setDoc, auth } = window.zimyFirebase;
            const therapist = window.Zimy.db.getSession();

            try {
                // 1. Update request status
                await setDoc(doc(null, "session_requests", requestId), { status }, true);

                if (status === 'accepted') {
                    // 2. Create chat document
                    const participantIds = [therapist.uid, userId].sort();
                    const chatId = participantIds.join('_');

                    await setDoc(doc(null, "chats", chatId), {
                        participantIds: participantIds,
                        lastMessage: "Sess√£o aprovada. Ol√°!",
                        lastMessageAt: new Date().toISOString(),
                        lastSenderId: therapist.uid,
                        therapistName: therapist.name,
                        patientName: userName
                    });

                    // Add to local storage for quick list (optional, but helps sync)
                    const patients = window.Zimy.db.load('patients');
                    if (!patients.find(p => p.id === userId)) {
                        patients.push({
                            id: userId,
                            name: userName,
                            status: 'online',
                            specialty: 'Novo Paciente',
                            emoji: 'üë§'
                        });
                        window.Zimy.db.save('patients', patients);
                    }
                }

                // Refresh UI
                fetchSessionRequests();
                fetchRecentPatients();
            } catch (error) {
                console.error("Error handling request:", error);
                alert("Erro ao processar pedido.");
            }
        }

        async function fetchRecentPatients() {
            const user = window.Zimy.db.getSession();
            if (!user || !user.uid) return;

            try {
                const { query, getDocs, getDoc, setDoc } = window.zimyFirebase;
                // Fetch chats where therapy is active
                let chats = await query("chats", [
                    { field: "participantIds", op: "ARRAY_CONTAINS", value: user.uid }
                ]);

                // --- AUTO REPAIR ---
                if (chats.length === 0) {
                    const allResources = await getDocs("chats");
                    for (const ch of allResources) {
                        const data = ch.data() || {};
                        if (ch.id.includes(user.uid) && (!data.patientName || data.patientName === 'Paciente' || !data.participantIds)) {
                            const ids = ch.id.split('_');
                            const patientId = ids.find(id => id !== user.uid);
                            let recoveredName = "Paciente";

                            try {
                                const reqId = ids.join('_');
                                const reqDoc = await getDoc("session_requests", reqId);
                                if (reqDoc.exists) {
                                    recoveredName = reqDoc.data().userName || "Paciente";
                                } else {
                                    const userDoc = await getDoc("users", patientId);
                                    if (userDoc.exists) recoveredName = userDoc.data().name || "Paciente";
                                }
                            } catch (e) { console.error("Recovery failed:", e); }

                            await setDoc("chats", ch.id, {
                                participantIds: ids,
                                therapistName: user.name || "Terapeuta",
                                patientName: recoveredName
                            }, true);
                            return fetchRecentPatients();
                        }
                    }
                }
                const container = document.getElementById('patientsTableBody');

                // Update top stats
                document.getElementById('statActivePatients').innerText = chats.length;

                const now = new Date();
                const sevenDaysAgo = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                const activeThisWeek = chats.filter(c => {
                    const d = c.data();
                    return d.lastMessageAt && new Date(d.lastMessageAt) > sevenDaysAgo;
                }).length;

                const engagement = chats.length > 0 ? Math.round((activeThisWeek / chats.length) * 100) : 0;
                document.getElementById('statEngagement').innerText = `${engagement}%`;
                document.getElementById('lblGoal').innerText = `Ativos: ${activeThisWeek}`;

                // For "Conversations/Month", we use total chats as a proxy since we don't have a global message counter
                document.getElementById('statConversations').innerText = chats.length;
                document.getElementById('statActiveDiff').innerText = chats.length > 0 ? `+${chats.length}` : '---';

                if (chats.length === 0) {
                    container.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-5 opacity-50">
                                <i class="fas fa-user-slash fs-2 mb-3 d-block"></i>
                                <span id="txtNoPatients">Nenhum paciente cadastrado ainda.</span>
                            </td>
                        </tr>
                    `;
                    return;
                }

                container.innerHTML = chats.map(chat => {
                    const data = chat.data();
                    const patName = data.patientName || 'Paciente';
                    return `
                        <tr>
                            <td style="padding:1rem 0;">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;font-weight:bold;color:var(--neon-blue);">
                                        ${patName.charAt(0)}
                                    </div>
                                    <span class="fw-semibold">${patName}</span>
                                </div>
                            </td>
                            <td><span class="badge-status badge-online">online</span></td>
                            <td style="color:var(--text-dim);font-size:0.88rem;">Terapia Ativa</td>
                            <td style="color:var(--text-dim);font-size:0.88rem;">${data.lastMessageAt ? new Date(data.lastMessageAt).toLocaleDateString() : '---'}</td>
                            <td><a href="chat.html?chatId=${chat.id}" class="btn btn-zimy-outline btn-sm px-3 py-1">Abrir Chat</a></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error("Error fetching patients:", error);
            }
        }
    </script>
</body>

</html>